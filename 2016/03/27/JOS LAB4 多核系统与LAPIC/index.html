<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>JOS lab4 Lapic与Intel多核系统 | TommyLiu's Blog</title><link rel="stylesheet" type="text/css" href="http://tommylwp.me//css/normalize.css"><link rel="stylesheet" type="text/css" href="http://tommylwp.me//css/highlight.css"><link rel="stylesheet" type="text/css" href="http://tommylwp.me//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="http:/tommylwp.me/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="http:/tommylwp.me/." class="title">TommyLiu's Blog</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="http:/tommylwp.me/" class="sidebar-nav-item">Home</a><a href="http:/tommylwp.me/archives" class="sidebar-nav-item">Archives</a><a href="http:/tommylwp.me/about" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>JOS lab4 Lapic与Intel多核系统</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-03-27</div><div class="post-tags"><a class="post-tag-link" href="http:/tommylwp.me/tags/JOS/">JOS</a></div></div></div><article><div class="container post"><h1 id="JOS-Lab4-SMP-system-and-LAPIC"><a href="#JOS-Lab4-SMP-system-and-LAPIC" class="headerlink" title="JOS Lab4 SMP system and LAPIC"></a>JOS Lab4 SMP system and LAPIC</h1><hr>
<p>JOS进入Lab4过后困惑我的一个问题是SMP(symmetric multiprocessing)究竟是怎么实现的，即操作系统是如何管理多CPU工作的？多CPU将如何影响我们设计JOS。</p>
<p>我下面写一下我目前的理解，如果有错误，请读者斧正。</p>
<h3 id="APIC"><a href="#APIC" class="headerlink" title="APIC"></a>APIC</h3><p>首先要明确一点：当我们要新运行一个进程时，<strong>选用哪个CPU不归OS管，这全由Intel的提供的APIC硬件帮助你决定。</strong></p>
<p>APIC是”Advanced Programmable Interrupt Controller”（高级可编程中断控制器），它位于Intel CPU内部，每一个CPU都有一个Local的APIC（叫做LAPIC），APIC是可编程(正如名字里的programmable)的，我们通过对LAPIC的寄存器进行读写，来和CPU进行交互。</p>
<h4 id="LAPIC寄存器-memory-maped-IO"><a href="#LAPIC寄存器-memory-maped-IO" class="headerlink" title="LAPIC寄存器 memory-maped IO"></a>LAPIC寄存器 memory-maped IO</h4><p>一个问题是——既然我们是要读写LAPIC的寄存器，那他们的地址是在哪里呢？</p>
<p>Intel默认把他们的地址映射到了虚拟内存空间FEC00000的地方。（而在jos实验中我们把它重新map到了一个比较低的地址，因为他太高了,对于我们一kernbase为基础的映射方式来说，这段话对于理解LAPIC无关。)</p>
<p>于是我们就像读写内存一样，可以读写APIC的寄存器。</p>
<p>那么下一个问题是，究竟APIC为我们提供了哪些信息呢？</p>
<p>在kern/lapic.c的顶部可以看到，大概包括了目前这个CPU的ID等一些列寄存器。在后续的BSP(最先启动的CPU)启动APs(其他CPU)的过程代码中，我们都看得到这些寄存器被使用，通过读写内存上的响应地址。</p>
<p>好了差不多，你就可以很顺畅的自己通过阅读JOS代码，开启LAB4了。:-D</p>
<hr>
<p>提供一个介绍APIC的链接供参考：<a href="http://wiki.osdev.org/APIC" target="_blank" rel="external">http://wiki.osdev.org/APIC</a></p>
<p>后附寄存器定义 位于Kern/lapic.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Local APIC registers, divided by 4 for use as uint32_t[] indices.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ID      (0x0020/4)   <span class="comment">// ID</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VER     (0x0030/4)   <span class="comment">// Version</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TPR     (0x0080/4)   <span class="comment">// Task Priority</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EOI     (0x00B0/4)   <span class="comment">// EOI</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SVR     (0x00F0/4)   <span class="comment">// Spurious Interrupt Vector</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENABLE  0x00000100   <span class="comment">// Unit Enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ESR     (0x0280/4)   <span class="comment">// Error Status</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICRLO   (0x0300/4)   <span class="comment">// Interrupt Command</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT     0x00000500   <span class="comment">// INIT/RESET</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STARTUP  0x00000600   <span class="comment">// Startup IPI</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELIVS   0x00001000   <span class="comment">// Delivery status</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ASSERT   0x00004000   <span class="comment">// Assert interrupt (vs deassert)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEASSERT 0x00000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LEVEL    0x00008000   <span class="comment">// Level triggered</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BCAST    0x00080000   <span class="comment">// Send to all APICs, including self.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OTHERS   0x000C0000   <span class="comment">// Send to all APICs, excluding self.</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUSY     0x00001000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIXED    0x00000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICRHI   (0x0310/4)   <span class="comment">// Interrupt Command [63:32]</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMER   (0x0320/4)   <span class="comment">// Local Vector Table 0 (TIMER)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> X1       0x0000000B   <span class="comment">// divide counts by 1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PERIODIC 0x00020000   <span class="comment">// Periodic</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PCINT   (0x0340/4)   <span class="comment">// Performance Counter LVT</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LINT0   (0x0350/4)   <span class="comment">// Local Vector Table 1 (LINT0)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LINT1   (0x0360/4)   <span class="comment">// Local Vector Table 2 (LINT1)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERROR   (0x0370/4)   <span class="comment">// Local Vector Table 3 (ERROR)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MASKED   0x00010000   <span class="comment">// Interrupt masked</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TICR    (0x0380/4)   <span class="comment">// Timer Initial Count</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCCR    (0x0390/4)   <span class="comment">// Timer Current Count</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TDCR    (0x03E0/4)   <span class="comment">// Timer Divide Configuration</span></span></span><br></pre></td></tr></table></figure>
</div><!-- comment system--><div class="container"><hr><div data-thread-key="2016/03/27/JOS LAB4 多核系统与LAPIC/" data-title="JOS lab4 Lapic与Intel多核系统" data-url="https://github.com/T0mmyliuhttp:/tommylwp.me/2016/03/27/JOS LAB4 多核系统与LAPIC/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'tommyliu'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="https://github.com/https://github.com/t0mmyliu" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow"></a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer></body></html>